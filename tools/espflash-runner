#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR=$(cd "$(dirname "$0")" && pwd)
REPO_ROOT=$(cd "$SCRIPT_DIR/.." && pwd)
ENSURE_ESP32_PORT="$REPO_ROOT/scripts/ensure_esp32_port.sh"

if [[ -z "${ESPFLASH_PORT:-}" ]]; then
  if [[ -f "$ENSURE_ESP32_PORT" ]]; then
    ESPFLASH_PORT="$(bash "$ENSURE_ESP32_PORT")"
  else
    echo "error: ESPFLASH_PORT is not set and '$ENSURE_ESP32_PORT' is missing." >&2
    echo "Set it explicitly, e.g.:" >&2
    echo "  ESPFLASH_PORT=/dev/tty.usbserial-XXXX cargo run" >&2
    echo "Or use:" >&2
    echo "  just fw-select-port" >&2
    echo "  just fw-flash" >&2
    exit 2
  fi
fi

if [[ ! -e "${ESPFLASH_PORT}" ]]; then
  echo "error: ESPFLASH_PORT='${ESPFLASH_PORT}' does not exist." >&2
  exit 2
fi

exec espflash flash --monitor --chip esp32s3 --log-format defmt --port "${ESPFLASH_PORT}" "$@"
