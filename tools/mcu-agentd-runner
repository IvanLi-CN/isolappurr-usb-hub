#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR=$(cd "$(dirname "$0")" && pwd)
REPO_ROOT=$(cd "$SCRIPT_DIR/.." && pwd)
PORT_FILE="$REPO_ROOT/.esp32-port"

err() { printf '%s\n' "$1" >&2; }

# cargo invokes the runner as: <runner> <path-to-elf> [args...]
ELF_PATH="${1:-}"
if [[ -n "$ELF_PATH" ]] && [[ "$ELF_PATH" == *"/debug/"* ]]; then
  err "error: cargo produced a debug ELF, but this project flashes the release ELF."
  err "Use: cargo run --release"
  err "Or:  just flash"
  exit 2
fi

if [[ ! -f "$PORT_FILE" ]]; then
  err "error: no port selected for this repo ($PORT_FILE missing)."
  err "Run:"
  err "  just ports"
  err "  PORT=/dev/cu.xxx just select-port"
  exit 2
fi

PORT_VALUE="$(head -n 1 "$PORT_FILE" 2>/dev/null || true)"
PORT_VALUE="$(printf '%s' "$PORT_VALUE" | tr -d '\r' | xargs)"
if [[ -z "$PORT_VALUE" ]] || [[ ! -e "$PORT_VALUE" ]]; then
  err "error: cached port '$PORT_VALUE' is not available."
  err "Run:"
  err "  just ports"
  err "  PORT=/dev/cu.xxx just select-port"
  exit 2
fi

if ! command -v mcu-agentd >/dev/null 2>&1; then
  err "error: mcu-agentd not found in PATH."
  err "Install it with: just agentd-init"
  exit 127
fi

mcu-agentd flash usb_hub
exec mcu-agentd monitor usb_hub --reset
