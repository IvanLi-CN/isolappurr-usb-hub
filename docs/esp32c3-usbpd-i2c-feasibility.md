# ESP32‑C3 单 I2C 主机驱动 SW2303 + TPS55288 + 2×INA226 的可行性分析

本报告评估在 **ESP32‑C3 只有 1 个硬件 I2C 主机（I2C0）**的前提下，使用同一条 I2C 总线同时连接：

- **SW2303**：USB‑C/USB‑A 快充协议控制器（含 USB PD/QC 等协议），且**只能轮询**获取状态/目标值；
- **TPS55288**：Buck‑boost 电源控制器（I2C 可编程输出/保护/斜率等参数）；
- **2× INA226**：电压/电流/功率监测（定期采样，**1–2 Hz**）；

并综合考虑 USB‑PD 的“电源切换时间窗”、I2C 物理层速率与固件调度，判断是否存在性能瓶颈及建议实现方式。

## 0. 结论摘要（先给结论）

- **可行**：单 I2C0（400 kHz）在带宽与延迟上都能覆盖“SW2303 轮询 + TPS55288 编程 + 2×INA226 低频采样”，不存在 I2C 吞吐瓶颈。
- **满足 PD 电源切换窗口**：采用 **5–10 ms** 轮询周期 + TPS55288 可配 VOUT 斜率，端到端“目标变化 → VBUS 到位”通常在 **几十毫秒以内**，远小于 USB‑PD 对电源切换的超时上限（量级为数百毫秒）。
- **关键风险不在速度，而在鲁棒性/实时性**：需要给 I2C 加超时、总线恢复、watchdog，并避免固件长时间阻塞导致轮询抖动。

---

## 1. 目标与需求

### 1.1 系统目标

- USB‑PD 协议由 **SW2303**与对端设备完成协商；MCU 负责把“协商结果落到电源输出”：
  - 从 SW2303 读出“目标输出电压/电流/协议状态/故障”等；
  - 编程 TPS55288，使 VBUS 按目标值变化（含 PPS / 快充档位变化等）。
- 2× INA226 用于**低频**电参量采样：每秒 1–2 次读取电压、电流、功率三项（遥测/统计/策略依据）。

### 1.2 性能关注点

- **电源输出响应**：从 SW2303 目标变化到 TPS55288 完成输出变化，需满足 USB‑PD 的电源切换时间窗。
- **I2C 负载**：轮询 + 监测 + 控制命令是否会把单条 I2C 总线塞满，从而拖慢响应。
- **实时性/鲁棒性**：轮询驱动对任务调度敏感，需避免“长时间阻塞”造成响应超时或失控。

---

## 2. 关键约束与器件能力（可核查来源）

### 2.1 ESP32‑C3 I2C 主机能力

ESP‑IDF 文档中明确：

- ESP32‑C3 **只有 1 个 I2C 控制器**（I2C0）；  
- I2C 主机模式下，**SCL 不应超过 400 kHz**（Fast‑mode）；  
- I2C 从设备可能会 clock stretching（文档提示“甚至可达 12 ms”），因此需要在固件层设置合理的超时/恢复策略。  

参考：Espressif ESP‑IDF I2C（ESP32‑C3）文档（“I2C_NUM_0 / 400k / stretching”段落）。

### 2.2 SW2303（轮询源）

- SW2303 I2C 支持 **100k/400k**；I2C 用于主机读取状态信息。  
  参考：`downloads/4c043a67-9736-4f94-9ded-5f4966d5e1da/d43f2be6-9968-4282-9fa1-788383da2c7f/full.md:178`
- 常用轮询寄存器（示例）：
  - `0x06`：快充/PD 版本/协议类型指示  
    `downloads/4c043a67-9736-4f94-9ded-5f4966d5e1da/12de1000-2aa3-48ae-bea8-f5c4fd77cb0e/full.md:31`
  - `0x03/0x04`：当前“设置电压”（dac_vol×10mV）  
    `.../full.md:19`
  - `0x05`：当前限流值（50mA/step）  
    `.../full.md:27`
  - `0x0D[7]`：在线/接入指示  
    `.../full.md:47`

> 结论：总线最高速率必须向 SW2303 对齐（≤400 kHz），并采用轮询机制获取变化。

### 2.3 TPS55288（被控电源）

- TPS55288 I2C 支持 **Standard‑mode（≤100 kbit/s）** 和 **Fast‑mode Plus（≤1000 kbit/s）**。  
  `downloads/50b5ca01-d68a-4c36-9238-b890259d8dd3/dd540207-b427-4999-b2ab-22f20c518a95/full.md:476`
- 输出电压变化斜率可由 `VOUT_SR` 寄存器设置：1.25 / 2.5 / 5 / 10 mV/µs。  
  `.../full.md:594`

> 结论：TPS55288 本身不限制 400 kHz；且输出电压变化速度可配置，利于满足 PD 电源切换窗口。

### 2.4 INA226（低频采样）

- INA226 支持 I2C Fast‑mode 至 **400 kHz**。  
  `downloads/71697b21-f2aa-4e69-b755-414ce23ffa1b/6a87f1e2-f25a-4b38-9e21-a56eb6a1db90/full.md:409`

> 结论：INA226 在 400 kHz 总线上工作无压力；1–2 Hz 的采样频率在带宽上几乎可以忽略。

---

## 3. I2C 总线吞吐与轮询开销估算（上界分析）

### 3.1 采用的保守假设

- I2C 总线频率：**400 kHz**（对齐 ESP32‑C3 + SW2303 上限）。
- **按最坏情况**估算：SW2303 不支持连续 burst 读取（每个寄存器单独一次读事务）。  
  若实际支持连续读取，负载会更低，本报告结论只会更稳。

### 3.2 单次 I2C 事务时间（数量级）

以常见“寄存器指针 + 读数据”的 1 字节读为例，事务可抽象为 4 个字节：

1) Addr+W（1B）→ 2) Reg（1B）→ 3) Addr+R（1B）→ 4) Data（1B）

I2C 每个字节含 ACK/NACK 近似按 **9 bit/Byte** 计算：

- **1 字节寄存器读**：约 4B × 9b = 36b  
  - @400 kHz：36 / 400k ≈ **90 µs**（未计入起止条件与少量软件开销；工程上按 **~100 µs**保守估算更稳）
- **1 字节寄存器写**：约 3B × 9b = 27b  
  - @400 kHz：27 / 400k ≈ **67.5 µs**
- **2 字节寄存器读**（如 INA226 某些寄存器）：约 5B × 9b = 45b  
  - @400 kHz：45 / 400k ≈ **112.5 µs**

### 3.3 SW2303 轮询负载（示例配置）

建议轮询周期：**5–10 ms**（详见第 4 节）。

假设每次轮询读取 SW2303 共 **10 个寄存器**（协议/电压/电流/在线/故障等）：

- 每次轮询耗时 ≈ 10 × 100 µs = **1.0 ms**
- 总线占用率：
  - 5 ms 轮询：1.0 / 5.0 = **20 %**
  - 10 ms 轮询：1.0 / 10 = **10 %**

即使按这个偏“重”的轮询集合，总线仍有充足余量承载 TPS55288 写寄存器与 INA226 低频采样。

### 3.4 INA226 采样负载（1–2 Hz）

每颗 INA226 读取 3 个 16‑bit（2B）数据项（电压/电流/功率），按“指针+读 2B”估算：

- 单项 2B 读取：~112.5 µs
- 单颗 3 项：~337.5 µs
- 2 颗：~675 µs
- 2 Hz：每秒 ~1.35 ms，总线占用率 ~0.135 %

结论：INA226 的 1–2 Hz 采样对 I2C 负载几乎没有影响。

---

## 4. 端到端响应时间与 USB‑PD 时间窗匹配

### 4.1 端到端响应链路

当 PD 协议协商导致目标输出变化时，MCU 的响应链路可抽象为：

1) 等待下一次轮询读到 SW2303 的目标变化（最大等待 **T_poll**）  
2) I2C 写 TPS55288 新的输出目标（几十到几百微秒量级）  
3) TPS55288 按配置的 slew rate 完成输出电压变化（毫秒量级）

因此端到端最主要的可控项是 **轮询周期 T_poll** 与 **TPS55288 输出斜率 SR**。

### 4.2 TPS55288 输出变化时间（可计算）

TPS55288 的输出变化斜率 SR 可设为 1.25 / 2.5 / 5 / 10 mV/µs。  
`downloads/50b5ca01-d68a-4c36-9238-b890259d8dd3/dd540207-b427-4999-b2ab-22f20c518a95/full.md:594`

示例：5 V → 20 V（ΔV = 15 V = 15000 mV）

- SR = 2.5 mV/µs（默认）：15000 / 2.5 = **6000 µs ≈ 6 ms**
- SR = 1.25 mV/µs：≈ **12 ms**

### 4.3 与 USB‑PD 的电源切换窗口对齐（结论导向）

公开可查的 USB‑PD 计时常量（Zephyr 项目按 USB‑PD 规范表格给出的常量）中：

- SPR 场景下，PS transition 计时器的最大值为 **550 ms**（名义 500 ms）；  
- EPR 场景下，该窗口更长（最大值达 **1020 ms**）。  

参考：Zephyr `usb_pd_timer.h`（Timer definitions / Table 6‑68）。

在本系统中，按保守参数估算：

- T_poll = 10 ms（最大检测延迟 10 ms）
- I2C 写 TPS55288 + 可选读回校验合计 < 1 ms
- TPS 输出变化 ≈ 6–12 ms（取决于 SR 与 ΔV）

端到端通常 **< 25 ms**，与 **~550 ms** 的量级差距非常大，因此**不会因为“单 I2C 主机 + 轮询”而触发 USB‑PD 电源切换超时**。

> 重要澄清：USB‑PD 的“消息响应定时器”（例如 tSenderResponse）主要约束 PD 消息交换本身；本方案里 PD 协议栈在 SW2303 内部，MCU 不在消息关键路径上，MCU 关注的是“把协商结果落到电源输出”的速度与鲁棒性。

---

## 5. 可能的瓶颈与风险（以及规避手段）

### 5.1 真正的瓶颈通常不是 I2C 带宽

从第 3 节可见，即使把轮询做得比较“重”，总线占用率依然显著低于 100%。更常见的性能/可靠性风险来自：

- **固件调度阻塞**：某些任务/临界区阻塞几十毫秒，导致轮询延迟抖动增大。
- **I2C 总线挂死**：SDA 被拉低、异常 clock stretching、噪声导致状态机卡住。

### 5.2 关键工程建议

- **轮询任务高优先级**：将 SW2303 轮询 + TPS 更新放在较高优先级任务中，避免被日志/网络等低优先级任务拖延。
- **I2C 超时与恢复**：
  - 每次事务设置明确 timeout；
  - 失败时执行总线恢复（例如 SCL 手动翻转 9 次 + 重新初始化 I2C 外设）；
  - 用 watchdog 兜底“永不返回”的异常路径。
- **减少无意义 I2C 访问**：只在 SW2303 的目标值/状态位变化时写 TPS55288（电压未变则不写）。
- **保护回路分层**：
  - 1–2 Hz 的 INA226 数据用于遥测/显示/慢速策略，不承担快速保护；
  - 快速保护依赖 TPS55288 的硬件 OVP/OCP/短路保护等，以及 SW2303 自身故障位。

### 5.3 I2C 电气与地址规划（容易被忽略）

- **地址规划**：
  - SW2303 文档示例给出 I2C slave address `0x3C`。`downloads/4c043a67-9736-4f94-9ded-5f4966d5e1da/d43f2be6-9968-4282-9fa1-788383da2c7f/full.md:184`
  - TPS55288 的 I2C slave address 为 `0x74/0x75`（由 MODE 引脚电阻选择）。`downloads/50b5ca01-d68a-4c36-9238-b890259d8dd3/dd540207-b427-4999-b2ab-22f20c518a95/full.md:480`
  - INA226 通过 A0/A1 支持 16 个地址（需为两颗器件选不同地址）。`downloads/71697b21-f2aa-4e69-b755-414ce23ffa1b/6a87f1e2-f25a-4b38-9e21-a56eb6a1db90/full.md:395`
- **电平与上拉**：
  - 确保所有 I2C 器件工作在同一 SDA/SCL 电压域；如必须跨电压域，选择能稳定支持 400 kHz 的双向电平转换方案并实测上升沿。
  - 400 kHz 下对上升沿更敏感：按总线电容选上拉电阻（工程上常见 2.2k–4.7k@3.3V，但应以波形为准）。
- **布线与噪声**：
  - I2C 走线尽量短、远离 TPS55288 开关节点与大 di/dt 回路；必要时加小串阻/RC 抑制尖峰并配合示波器验证。

---

## 6. 推荐实现参数（落地可直接用）

- I2C 总线频率：**400 kHz**
- SW2303 轮询周期：**5–10 ms**
  - 连接/协商窗口：建议 5 ms
  - 稳态输出：可放宽到 10–20 ms（若需要进一步降低总线占用）
- INA226 采样：**1–2 Hz**（独立低优先级任务）
- TPS55288：
  - 根据负载与 EMI 需求选择 `VOUT_SR` 的 SR；默认 2.5 mV/µs 在“响应速度 vs EMI/过冲”之间通常较均衡

---

## 7. 验证计划（建议用示波器/逻分一次做完）

- **I2C 物理层**：确认 SCL 频率、上升沿、ACK/NACK、是否存在异常 clock stretching。
- **轮询实时性**：统计轮询周期抖动（min/avg/max），确保 max 不超过目标（例如 10 ms）。
- **端到端响应**：在 PD 档位变化（或 PPS 步进）时，测量：
  - SW2303 目标寄存器变化 → TPS55288 寄存器更新延迟
  - TPS 更新 → VBUS 达到新目标的时间
- **故障注入**：短暂拉低 SDA/SCL 或增加干扰，验证 I2C 恢复与系统不会“卡死不回”。

---

## 8. 结论

在 **ESP32‑C3 单 I2C 主机 + 400 kHz 总线**条件下，使用轮询驱动 SW2303，并同时控制 TPS55288、低频采样 2×INA226：

- **带宽完全足够**，不会形成性能瓶颈；
- 通过 **5–10 ms** 的轮询周期与 TPS55288 可配置的输出斜率，端到端响应通常 **< 25 ms**，与 USB‑PD 电源切换时间窗相比余量充足；
- 真正需要工程化关注的是 **固件阻塞**与 **I2C 总线异常恢复**，按第 5 节建议实现即可把风险压到可控范围。

---

## 参考链接（便于复核）

- Espressif ESP‑IDF I2C（ESP32‑C3）：https://docs.espressif.com/projects/esp-idf/en/latest/esp32c3/api-reference/peripherals/i2c.html
- Zephyr USB‑PD timer（含 PS transition 定时常量）：https://docs.zephyrproject.org/apidoc/latest/group__usb__pd__timer.html
- SW2303 I2C 速率与用途：`downloads/4c043a67-9736-4f94-9ded-5f4966d5e1da/d43f2be6-9968-4282-9fa1-788383da2c7f/full.md:178`
- TPS55288 I2C 速率与 VOUT_SR（slew rate）：`downloads/50b5ca01-d68a-4c36-9238-b890259d8dd3/dd540207-b427-4999-b2ab-22f20c518a95/full.md:476`、`.../full.md:594`
- INA226 I2C 速率：`downloads/71697b21-f2aa-4e69-b755-414ce23ffa1b/6a87f1e2-f25a-4b38-9e21-a56eb6a1db90/full.md:409`
- SW2303/TPS55288/INA226 地址信息：`downloads/4c043a67-9736-4f94-9ded-5f4966d5e1da/d43f2be6-9968-4282-9fa1-788383da2c7f/full.md:184`、`downloads/50b5ca01-d68a-4c36-9238-b890259d8dd3/dd540207-b427-4999-b2ab-22f20c518a95/full.md:480`、`downloads/71697b21-f2aa-4e69-b755-414ce23ffa1b/6a87f1e2-f25a-4b38-9e21-a56eb6a1db90/full.md:395`
