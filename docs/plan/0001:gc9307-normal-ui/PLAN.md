# GC9307 正常界面规范（USB‑A + USB‑C/PD 双口电参量）（#0001）

## 状态

- Status: 已完成
- Created: 2026-01-07
- Last: 2026-01-08

## 背景 / 问题陈述

- 现状：GC9307 屏幕曾显示为 TPS+SW 测试界面，不适合日常观测两路接口的电参量。
- 目标：替换为“正常界面”，用于日常观测屏幕下方两路接口：
  - 左：USB‑A
  - 右：USB‑C（支持 PD）
- 约束：界面需要输出对外可观察、可测试的定宽格式与判定规则，作为实现与测试的基线。

## 目标 / 非目标

### Goals

- 两列三行显示：Voltage / Current / Power（单位分别为 `V` / `A` / `W`）。
- 提供一致、可读、定宽的数值格式化规则（含四舍五入、超量程、未插入、错误）。
- 明确端口“未插入”判定与状态优先级。
- 明确数据来源：V/I/P 来自对应口 INA226；功率必须读 INA226 Power 寄存器。
- 定义刷新周期与颜色规范，便于快速识别。

### Non-goals

- 菜单/切页/交互、历史曲线、数据记录/上报。
- 显示 PD 协议细节（PDO、协议类型、请求值等）。
- 改动 PD 协同控制策略与主循环功能行为。

## 范围（Scope）

### In scope

- UI 布局：固定为 **3 行 × 2 列**，每行 **13 个字符**：`左单元(6) + 空格(1) + 右单元(6)`。
- 单元格式：正常数值（定宽）、未插入、错误、超量程。
- 数值量级规则与舍入（half-up，允许跨阈值进位并切换格式）。
- 颜色规范（背景/正常值/状态色与优先级）。
- 硬件映射（tps-sw）：U13/U17 地址、分流电阻、关键网络关系。
- INA226 校准参数与功率换算规则（固定参数）。

### Out of scope

- 采样频率的强制规定（只要求每次刷新使用当前可用最新测量值）。
- PD 协议流程与策略变更。

## 需求（Requirements）

### MUST

- 固定布局：每次刷新输出 **3×2** 内容；每行严格为 **13 字符**：`left_cell(6) + ' ' + right_cell(6)`。
- 单元宽度固定为 **6 字符**，支持以下状态：
  - OK：按量级输出定宽数值并附单位 `V/A/W`
  - 未插入：`--.--U`（单位随行固定）
  - 错误：`ERROR `（末尾 1 空格）
  - 超量程：`OVER  `（末尾 2 空格）
- 舍入与量级规则：
  - `0.000 ≤ x < 10.000` → `D.ddd`
  - `10.00 ≤ x < 100.00` → `DD.dd`
  - `100.0 ≤ x < 1000.0` → `DDD.d`
  - 按最终显示精度四舍五入（half-up），允许跨阈值进位（例：`9.9996V → 10.00V`）。
- 状态优先级：`未插入 > ERROR > OVER > OK`（对每个端口、每个指标项独立判定）。
- 数据来源约束：
  - V/I/P 来自对应口 INA226；
  - 功率必须读取 INA226 Power 寄存器（不得由 V×I 计算）。
- 刷新：屏幕每 **500ms** 刷新一次。
- 端口“未插入”判定：
  - USB‑A：若电压读数有效且 `< 1.0V` → 未插入；否则视为已插入（包含读数错误）。
  - USB‑C/PD：以 SW2303 的“协议激活状态”判定；不得使用 `online` bit；不得使用“VBUS 是否为 5V keep-alive”判定未插入。
- 硬件映射（tps-sw）：
  - USB‑A：INA226 `U13`，I2C 7-bit `0x40`，分流 `R22=10mΩ`（`P1_SNP ↔ P1_VBUS`）。
  - USB‑C/PD：INA226 `U17`，I2C 7-bit `0x41`，分流 `R29=10mΩ`（`ISP_TPS ↔ VOUT_TPS`）。
  - `VOUT_TPS` 通过 `Q7` 连接到 `VBUS_TPS`。
- INA226 校准固定参数（实现必须使用）：
  - U13：`Current_LSB=62µA/bit`，`Calibration=8258`（目标 `I_MAX=2.000A`）
  - U17：`Current_LSB=107µA/bit`，`Calibration=4785`（目标 `I_MAX=3.500A`）
- 功率换算：`Power_LSB = 25 × Current_LSB`；读取失败视为 `ERROR`。
- 颜色（RGB565；不改变字符布局）：
  - 背景：黑色 `0x0000`
  - OK：Voltage `0xFE45` / Current `0xF206` / Power `0x4D6A`
  - 状态色：未插入 `0x8410` / 错误 `0xF800` / 超量程 `0xFCC0`

### SHOULD

- 每次刷新使用当前可用的最新测量值；插入状态下任一项读取失败显示 `ERROR `，不影响其它项显示。

### COULD

- -

## 验收标准（Acceptance Criteria）

- Given：进入正常界面  
  When：每 500ms 触发一次刷新  
  Then：显示 3 行 × 2 列的 V/A/W 内容，且每行严格满足 13 字符布局（左 6 + 空格 + 右 6）。
- 未插入：
  - USB‑A：当电压 `<1.0V` 时，该口三行均显示 `--.--U`。
  - USB‑C：当协议未激活时，该口三行均显示 `--.--U`。
- 错误/超量程：
  - 插入状态下任一项读取失败显示 `ERROR `，不影响其它项显示。
  - 插入状态下任一项 `x ≥ 1000.0` 显示 `OVER  `。
- 格式化：
  - 任意正常数值必须满足“4 个数字 + 小数点 + 单位字母”的定宽要求。
  - 在阈值附近的四舍五入与跨阈值进位符合“需求/MUST/舍入与量级规则”。

## 里程碑（Milestones）

- [x] M1: 冻结“正常界面”口径（布局/格式/状态/颜色/判定/校准）
- [x] M2: 实现 UI 渲染、端口存在性判定与 V/I/P 遥测（功率来自 INA226 Power）
- [x] M3: 产出 1:1 像素效果图与 UI 设计文档
- [x] M4: 产出面向使用者的功能说明文档

## 方案概述（Approach, high-level）

- 渲染节奏：以 500ms tick 驱动 UI 更新。
- 每端口三项分别读出 Field（Ok/Err），结合端口 present 判定后渲染到定宽 cell。
- 数值格式化：按 3/2/1 位小数三档，half-up 舍入，超量程显示 `OVER  `。
- 配色：行级 OK 色（V/I/P）+ 状态色覆盖（未插入/错误/超量程）；背景为黑色。

## 风险与开放问题（Risks & Open Questions）

- 风险：I2C 读失败/异常值会导致 `ERROR ` 频繁出现；需保证总线鲁棒性与超时恢复策略。
- 风险：校准参数或分流电阻变更会破坏显示量纲与溢出边界；硬件改版需同步更新本 Plan。
- 开放问题：无。

## 原始输入（摘录）

> 本 Plan 的口径来源于一份已冻结的“正常界面规范”文档（创建于 2026-01-07）。  
> 摘录：界面以两列显示两口的电压/电流/功率，定宽格式化，500ms 刷新，功率必须读 INA226 Power 寄存器；USB‑A 以 VBUS<1.0V 判定未插入，USB‑C/PD 以协议激活判定未插入，且不使用 online bit。

## 参考（References）

- `docs/gc9307-normal-ui-ui-design.md`（UI 设计与效果图）
- `docs/gc9307-normal-ui-functional.md`（功能说明）
- `docs/hardware-variants.md`（硬件适用范围）
- `hardware/tps-sw/netlist.enet`（网表）
- `docs/plan/0001:gc9307-normal-ui/tools/gc9307_render_preview.py`（预览图生成脚本）
