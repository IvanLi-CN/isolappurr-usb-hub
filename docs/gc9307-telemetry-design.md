# GC9307 屏幕遥测显示（Frozen v1：U17(meas) + U14(meas derived) + SET(applied)）

本文档已按主人确认冻结为 **v1 规格**：在 GC9307 横屏上以 **10 Hz** 刷新显示三组（电压/电流）信息，并明确总线/地址/数据口径/错误显示策略，作为实现阶段的基线。

适用硬件：`tps-sw`（见 `docs/hardware-variants.md`）。`ip6557` 的遥测/显示方案如有差异，后续另行补齐。

---

## 1. 背景与目标

### 1.1 背景

- 本项目已有 USB‑PD 协同控制：MCU 轮询 `SW2303` 并写入 `TPS55288`（详见 `docs/pd-i2c-coordinator-design.md`）。
- 现在需要在板载 **1.47" GC9307** 屏幕上展示电源输出的实时信息，便于调试与日常使用。

### 1.2 目标（必须）

- 屏幕方向：**横屏**
- 刷新率：**10 Hz（100 ms）**
- 显示三组信息（每组含电压与电流/限流字段）：
  1) `U17(meas)`：实测 `V/I`（来源：INA226，I2C 读取）
  2) `U14(meas)`：推导实测 `V/I`（U14 与 U17 共用检流电阻，见 §6.2）
  3) `SET(applied)`：设定值 `V/Ilimit`（来源：固件实际应用的 `PowerSetpoint`，见 §6.3）
- 错误显示：任一字段采样/计算失败，屏幕对应字段显示 **`ERR`**（不保留上一帧）。

### 1.3 冻结说明（作为实现基线）

本设计已冻结为以下基线：

- 刷新节奏：**10 Hz**（采样与屏幕同频）
- 屏幕方向：**横屏**
- 三行内容定义：
  - `U17(meas)`：真实测量值（INA226）
  - `U14(meas)`：推导测量值（共享检流电阻，`V_u14 = V_u17 + I*Rshunt`）
  - `SET(applied)`：实际应用 setpoint（`PowerSetpoint.v_out_mv / i_lim_ma`）

---

## 2. 范围与非目标

### 2.1 范围（In Scope）

- 新增「遥测采样 + 屏幕显示」功能的需求定义与模块划分。
- 明确 I2C 总线拓扑、器件地址、关键 GPIO/NET 的对照关系。
- 明确刷新策略（10 Hz）与对 PD 协同回路的影响与隔离手段。

### 2.2 非目标（Out of Scope）

- 触摸/按键交互、菜单、历史曲线、数据记录、上报等扩展功能。
- 对 PD 协同控制策略做功能扩展（仍按既有设计）。
- I2C 地址扫描与自动发现（明确禁止，避免误触碰未知器件）。

---

## 3. 用户与核心场景

- **使用者**：主人（调试/验证/日常观测）。
- **场景**：
  - 上电后实时观察输出电压/电流是否符合预期。
  - USB‑PD 协商变化或限流动作时，观察实测/设定的变化关系。
  - I2C/SPI 异常时，屏幕给出可识别的错误状态，避免“卡死无反馈”。

---

## 4. 硬件与可行性结论

### 4.1 屏幕与驱动

- 屏幕：`T147BG-C08-06`（GC9307 控制器，SPI 接口）。
- 驱动：`gc9307-async`（crate 文档/示例提供同款屏幕用法）。
- 可行性：SPI 带宽足以支撑 172×320、16bpp 的 10 Hz 刷新；更推荐以「静态 UI + 局部重绘数字」降低阻塞（见 §8）。

> 备注：PDF 手册路径在主人机器上：`/Users/ivan/Sync/Ivan-Personal/Datasheets/Display/1.47 寸 GC9307/T147BG-C08-06.pdf`

### 4.2 分流电阻（检流）

- U17 与 U14 共用检流电阻：**10 mΩ**（主人实测设定/说明）。
- 最大电流：**5 A**（理论上限，用于 INA226 校准与量程/显示策略）。

---

## 5. 总线/地址/GPIO（必须钉死）

### 5.1 PD 协同 I2C（I2C0，总线 `SDA_TPS/SCL_TPS`）

来自固件与设计文档（`src/bin/main.rs`、`src/pd_i2c/mod.rs`、`docs/pd-i2c-coordinator-design.md`）：

- I2C 控制器：`I2C0`
- 频率：`400 kHz`
- 引脚：
  - `SDA_TPS`：GPIO39（U19 pin44 / `MTCK`）
  - `SCL_TPS`：GPIO40（U19 pin45 / `MTDO`）
- 设备与地址（7-bit）：
  - `SW2303`：`0x3C`
  - `TPS55288`：`0x74`

### 5.2 遥测 I2C（I2C1，总线 `SDA/SCL`）

来自网表 `hardware/tps-sw/netlist.enet`：

- I2C 控制器：**建议使用 `I2C1`**（与 PD 总线隔离）
- 频率：建议 `400 kHz`（与 INA226 Fast‑mode 匹配）
- 引脚：
  - `SDA`：U19 pin13 → GPIO8
  - `SCL`：U19 pin14 → GPIO9
  - `INT`：U19 pin12 → GPIO7（可选，用于 INA226 ALERT/INT）
- 设备与地址（7-bit）：
  - `INA226 (U17)`：`0x41`（A1=GND、A0=3V3）
  - `EEPROM (U21)`：`0x50`（同总线存在，必须避免误访问）
- 约束（冻结）：**禁止扫描**；遥测 I2C 必须按 allowlist **仅允许访问 `0x41`**。

### 5.3 屏幕 SPI 与控制脚

来自网表 `hardware/tps-sw/netlist.enet`（U19 与 FPC1）：

- SPI 信号：
  - `MOSI`：U19 pin16 → GPIO11
  - `SCLK`：U19 pin17 → GPIO12
  - `CS`：U19 pin18 → GPIO13
- 控制信号：
  - `DC`：U19 pin15 → GPIO10
  - `RES`：U19 pin19 → GPIO14
  - `BLK`：U19 pin21（pin name 为 `XTAL_32K_P`，v1 默认作为背光控制 GPIO 使用；若未来启用 32k 晶振需调整策略）

> `BLK` 通过 Q8（BSS84，P 沟道 MOSFET）控制 FPC1 pin1（通常为背光 LEDA）从 `3V3` 取电，实现背光开关（必要时可做 PWM 调光，非本次必需）。

---

## 6. 数据来源定义（压实“实测 vs 设定”）

### 6.1 U17（实测）

- 器件：INA226（I2C 读取）
- 输出字段：
  - `U17.V_meas`：INA226 bus voltage（映射到输出电压）
  - `U17.I_meas`：INA226 current（基于 shunt voltage + 校准）
- 校准输入：
  - `Rshunt = 10 mΩ`
  - `Imax_expected = 5 A`

### 6.2 U14（推导实测，主人已确认）

由于 `U14(TPS55288)` 与 `U17(INA226)` 共用同一检流电阻 `R29=10mΩ`（连接 `ISP_TPS <-> VOUT_TPS`）：

- `I_u14 = I_u17`
- `V_u14 = ISP_TPS = V_u17 + I_u17 * 0.010 Ω`

> 说明：TPS55288 的 I2C 不提供“实测 V/I”；本项目 v1 采用共享 shunt 的推导方式满足“U14 实测”口径。

### 6.3 SET(applied)（设定值，主人已确认用 B）

- 来源：固件**实际应用到 TPS** 的 `PowerSetpoint`（`v_out_mv / i_lim_ma`）
- 显示字段：
  - `V_set = PowerSetpoint.v_out_mv`
  - `I_lim = PowerSetpoint.i_lim_ma`

---

## 7. 模块边界（固件侧）

> 本节只定义模块职责与接口形状，不提前写实现代码。

- `telemetry`（采样域）：
  - 负责从 U17（INA226）采样并产出 `TelemetrySnapshot`
  - 若主人追加“第二路实测”需求（例如另一颗 INA226 或 ADC），负责采样并合并到 snapshot
- `pd_i2c`（既有）：
  - 继续负责 SW2303 轮询与 TPS55288 setpoint 下发
  - 对外暴露当前 `PowerSetpoint`（用于 `SET(applied)` 行显示）
- `display_ui`（显示域）：
  - 初始化 GC9307（横屏）
  - 绘制静态 UI 框架（标签/单位）
  - 以 10 Hz 更新数值区域（局部重绘）

---

## 8. 刷新与性能策略（10 Hz）

### 8.1 调度策略

- PD 协同回路：保持高优先级、短阻塞（仍按既有设计周期）
- 遥测采样：每 `100 ms` 采样一次（与屏幕刷新同频即可）
- 屏幕刷新：每 `100 ms` 更新一次数字区域

### 8.2 屏幕更新方式（推荐）

为避免 SPI 全屏刷导致 PD 协同“被长时间阻塞”，采用：

1) 上电后绘制一次静态 UI（标题/三行标签/单位）。
2) 每帧只擦除并重绘变化的数字区域（例如每行一个矩形区域）。

可行性判断依据：

- 分辨率 172×320；全屏 16bpp 一帧约 110 KB；10 Hz 约 1.1 MB/s（SPI 带宽通常可承载）。
- 但“全屏刷新”会造成单次传输时间显著增长；局部刷新可更稳。

---

## 9. 错误处理与降级

- I2C1（U17/INA226）读取失败：
  - `U17(meas)` 对应字段显示 `ERR`
  - `U14(meas)` 依赖 `U17(meas)` 推导，因此同样显示 `ERR`
- `SET(applied)` 获取失败（例如未能得到 `PowerSetpoint`）：
  - 对应字段显示 `ERR`
- SPI/屏幕初始化失败：
  - 不影响 PD 协同（仍能供电）
  - 串口日志输出错误并进入“无屏幕模式”

---

## 10. 验收标准（Acceptance Criteria）

### 10.1 核心路径

- [ ] 上电后 1s 内屏幕点亮，横屏显示三组字段框架。
- [ ] U17 行每 100 ms 更新一次，显示电压/电流，单位正确。
- [ ] U14 行按 `V_u14 = V_u17 + I*10mΩ` 推导显示，且电流与 U17 一致（允许测量噪声）。
- [ ] SET 行显示 `PowerSetpoint.v_out_mv / i_lim_ma`（applied setpoint）。

### 10.2 边界与异常

- [ ] U17 I2C 短暂失败时，屏幕出现 `ERR`，且系统不死机。
- [ ] 屏幕不可用时，PD 协同仍可运行（供电不受影响）。

---

## 11. 默认显示策略（已冻结）

为便于进入实现阶段，本次将以下细节也一并冻结为默认值（后续可在不改架构的情况下微调）：

1) **显示格式（默认）**：
   - 电压：`xx.xx V`
   - 电流：`x.xx A`
2) **错误显示（默认）**：
   - 采样/读回失败时显示 `ERR`，不显示“可能过期的上一次值”，避免误判。
3) **背光（默认）**：
   - 默认点亮（不开 PWM 调光）。
4) **硬件风险提示**：
   - `BLK` 连接在 U19 pin21（pin name 为 `XTAL_32K_P`）。若未来需要启用 32k 晶振功能，应调整背光控制策略（例如固定常亮或改用其它 GPIO）。
