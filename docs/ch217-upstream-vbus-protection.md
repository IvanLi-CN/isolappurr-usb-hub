# CH217 作为上行 USB‑C VBUS（5 V）保护/限流开关的设计笔记

本笔记记录：在 IsolaPurr USB Hub 项目中，决定在 **上行（连接主机的 USB‑C 口）VBUS** 上使用 **WCH CH217** 作为保护/限流器件，替代“上行口串 PPTC 自恢复保险丝”的常见做法。

## 1. 背景与目标

上行口 VBUS 的电气角色通常包括：

- **供电输入**：本项目上行 USB‑C 口可能作为系统输入电源来源之一。  
- **VBUS 存在检测**：用于 USB 设备上电/枚举相关逻辑。  
- **故障保护**：当上行口发生短路、线缆异常或板上故障时，限制从主机侧拉取的电流，避免对主机口造成冲击。

本项目选择 CH217 的主要目标是：在上行口提供**可控的电流限制 + 快速限流保护**，并保留 `FLAG#` 故障指示能力。

## 2. 方案选择：PPTC vs CH217

常见方案：

- **PPTC（自恢复保险丝）**：成本低、简单、无控制脚；但动作电流/响应速度/压降一致性较难精确控制，且过流时发热明显。

本项目方案：

- **CH217（USB 限流配电开关）**：通过外置电阻设定限流门限，短路时快速限流，压降由开关导通电阻决定；同时提供 `EN#` 使能与 `FLAG#` 故障输出，便于系统做“检测‑关断‑重试/告警”的策略。

## 3. CH217 关键能力摘要（用于上行 VBUS 的约束点）

来自 WCH CH217 产品页的关键特性：

- 供电电压：**2.7 V–5.5 V**  
- 可编程限流：**400 mA–2.7 A（典型误差 ±10%）**  
- 内置功率开关管，典型 **70 mΩ** 导通电阻  
- 短路快速限流  
- 低功耗：典型静态工作电流 **50 µA**；关机电流典型 **<1 µA**  
- **关断时没有反向电流**（用于防止上行口被反灌时的设计依据）  
- 封装：SOT23‑6  

引脚命名（来自 WCH 发布的器件 PDF 图示页）：`VIN` / `VOUT` / `GND` / `ISET` / `EN#` / `FLAG#`。

## 4. 设计实现建议（与本项目相关）

### 4.1 上行口电压等级约束（重要）

CH217 的供电上限为 **5.5 V**，因此：

- 若上行 USB‑C 口参与 USB‑PD 协商，必须确保最终合同电压保持在 **5 V 档位**（例如 5 V@3 A），否则不得将 CH217 串在上行 VBUS 主电源通路上。  
- 若未来希望从上行口获取 **9/12/15/20 V** 等更高电压，应替换为高耐压 eFuse/电源开关或改为先降压后再做 5 V 端口分配。

### 4.2 反灌（Back‑Power）风险与 `EN#` 控制

CH217 的“无反向电流”特性为**关断状态**下的描述，因此在存在多路供电（例如外置 DC 口 + 上行口）的系统中：

- 建议将 `EN#` 与上行 VBUS 存在检测关联：当检测到上行 VBUS 不存在时，保持 CH217 关断，避免系统侧电源通过上行口向主机**反向供电**。  
- 若系统架构使得 CH217 可能在“开启状态下”面对 VOUT 高于 VIN 的情况，应在原理图级明确：由电源 OR‑ing/理想二极管方案承担反向隔离，或选用明确支持反向阻断（含开启态）的器件。

### 4.3 上行 VBUS 端口电容与浪涌

对 **USB 2.0 bus‑powered** 设备，规范对上电浪涌有明确限制，工程上常用的落地规则是：

- **连接器 VBUS 侧总电容不超过 10 µF**；若确实需要更大电容，应通过软启动/限浪涌方式确保不超过规范的浪涌要求。  

在本项目中，推荐做法是：

- 将较大的系统储能电容尽量放在 CH217 之后（系统侧），并利用 CH217 的限流/启动行为降低上电浪涌；  
- 连接器侧仅保留满足 EMI/ESD 的必要小电容与器件输入去耦。

### 4.4 TVS/ESD 的摆放：放在 CH217 前还是后？

这里先给一个结论：**若你的主要目标是“抗插拔/ESD，把瞬态挡在板外”，TVS 应放在连接器侧（也就是 CH217 的 `VIN` 这一侧），并尽量靠近 USB‑C 连接器。**

原因很直接：

- CH217 的 `VIN` 绝对最大值上限为 **6 V**（见 `docs/datasheets/ch217-datasheet.md` 的“绝对最大值”表），而插拔/ESD/EFT 这类瞬态在连接器处可能造成远高于 6 V 的尖峰；  
- TVS 如果放在 CH217 之后（`VOUT`/系统侧），那么这段瞬态会先“打到 CH217”再被钳位，风险点反而落在 CH217 自己身上。

同时也要承认一个现实 trade‑off（你感觉“有问题”的点大概率在这里）：

- **把 TVS 放在 CH217 之前（连接器侧）**  
  - 优点：对 CH217 与后级都更“前置保护”，ESD 电流回路更短、更容易把干扰约束在接口附近；  
  - 风险：如果 TVS 发生失效短路（少见但需要考虑），它会让主机 VBUS 直接短到地，主机端口会触发过流保护/掉电。
- **把 TVS 放在 CH217 之后（系统侧）**  
  - 优点：TVS 失效或重浪涌时，CH217 的限流/关断能力可以帮助“隔离”主机端口，避免把故障直接甩给主机；  
  - 风险：CH217 的 `VIN` 侧暴露在连接器瞬态下，你就需要额外确认 CH217 的抗 ESD 能力是否足够（多数情况下不建议只靠“运气/模糊指标”）。

因此更稳妥的工程做法通常是二选一：

- **单颗方案（推荐优先级：ESD 防护优先）**：TVS 放在 **连接器侧（CH217 `VIN`）**，并把 CH217 同样尽量靠近连接器，减少未受保护走线长度；  
- **双级方案（ESD + 故障隔离都想要）**：连接器侧放一颗“低电容 ESD/TVS（偏 ESD 事件）”，系统侧（CH217 `VOUT`）再放一颗“浪涌能力更强的钳位器件（偏 EFT/Surge/重复应力）”，让 CH217 既被保护、又能在后级钳位器件异常时起到限流隔离作用。

不管你选哪种，布局层面有一个共同原则：**TVS 必须靠近接口/被保护节点，且到地回路要短、粗、低电感**（可用地铜+多过孔并联做回流），否则“看起来有 TVS”，效果也会被寄生电感吃掉。

## 5. 参考资料

- `docs/datasheets/ch217-datasheet.md`（CH217 手册 Markdown 版）  
- WCH 产品页：USB 限流配电开关芯片 CH217（特性摘要与内部框图）  
  https://wch.cn/products/CH217.html
- WCH PDF：CH217 引脚/封装图示页（用于引脚命名）  
  https://www.wch.cn/uploads/file/20230523/1684843869494238.pdf
- Silicon Labs AN0046《USB Hardware Design Guidelines》（包含 “Keep total load capacitance on VBUS below 10 uF” 的设计建议）  
  https://www.silabs.com/documents/public/application-notes/an0046-efm32-usb-hardware-design-guidelines.pdf
