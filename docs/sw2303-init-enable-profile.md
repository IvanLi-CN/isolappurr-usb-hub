# SW2303 初始化协议/档位启用（Enable Profile）需求分析与概要设计

> 状态：设计阶段（Frozen）。本文仅定义“预期行为/边界/权衡”，不包含实现代码。

---

## 1. 背景与目标

### 1.1 背景

当前固件仅通过 I2C **读取** `SW2303` 的协商结果（目标电压/限流/协议等），并未对 `SW2303` 执行“协议/档位”相关的写入配置。

正常情况下，`SW2303` 上电默认应启用主流快充协议与对应档位；但现实中可能存在**定制款/批次差异**，导致默认配置并非数据手册默认值，从而出现：

- 某些协议（如 PD/QC/SCP/…）未启用，导致设备无法触发快充；
- PD 固定档位 / PPS 档位被禁用，导致协商能力受限；
- 配置与整机能力不一致，导致行为不可预测。

因此需要 MCU 在初始化 `SW2303` 后，**主动把协议与档位设置到“已知、可复现”的目标配置**，而不是依赖默认值。

### 1.2 目标

- 在系统启动后，`SW2303` 的协议与档位处于一个**明确、可复现**的 Profile（“Enable Profile”）。
- Profile 应用过程具备**读回校验**与**可观测性**（日志/（可选调试寄存器快照）），便于定位“写不进去/被锁/定制差异”。
- 不破坏既有架构：仍以 MCU 轮询 `SW2303` → 写入 `TPS55288` 为主控制链路（详见 `docs/pd-i2c-coordinator-design.md`）。
  - 本次 Profile 目标：**启用全部协议与档位**（包含 `BC1.2 / PD / QC2.0 / QC3.0 / SCP(高压+低压) / AFC / FCP / SFCP / PE`，以及 PD 固定档位与 PPS0~PPS3）。

---

## 2. 范围与非目标

### 2.1 范围（In Scope）

- 在固件启动阶段对 `SW2303` 应用“Enable Profile”（协议/档位主动启用）。
- 仅修改寄存器手册中**定义过的 bit**，禁止改写未定义位/保留位（由驱动内部通过 read-modify-write 实现）。
- 写入后读回校验；失败时按预定义策略处理（重试/降级/报警）。

### 2.2 非目标（Out of Scope）

- 深度定制 `SW2303` 的协商策略（例如自定义 PDO 内容、VID/XID、异常处理策略等），除非后续明确新增需求。
- 与 `TPS55288` 以外的电源器件/遥测器件联动（仍遵循 I2C 白名单与总线隔离策略）。
- UI/配置持久化/远程控制（后续如需再单独立项）。

---

## 3. 关键用例 / 流程

### 3.1 上电初始化（主路径）

1) MCU 完成 PD 协同 I2C 初始化（地址白名单仍仅允许 `0x3C` 与 `0x74`）。  
2) 等待 `SW2303` 上电稳定且 I2C 可读（例如可读取到芯片版本号：通过驱动 API；若驱动缺失则先在 `sw2303-rs` 补齐）。  
3) 执行一次“Enable Profile”应用：
   - 驱动执行写入解锁（按手册序列，细节封装在驱动内）
   - 调用驱动的配置 API 应用 profile（协议/档位/功率上限等）
   - 调用驱动 status API 读回校验并记录结果
4) 进入既有轮询/协同流程（`SW2303` → `TPS55288`）。

### 3.2 异常与恢复（简化要求）

- 如果检测到 `SW2303` 疑似复位/配置丢失（例如关键 status 字段读回与期望不一致（通过驱动 API），或 I2C 失败后重新 init），允许再次应用 Profile（需定义触发条件与限频）。

---

## 4. 领域模型（固件内部）

> 本节仅定义结构“形状”，具体实现另行阶段执行。

- `Sw2303EnableProfile`：描述“哪些协议/档位必须启用”的目标集合。
- `Sw2303ProfileApplyResult`：记录应用结果（成功/失败原因/读回快照）。

建议 Profile 至少分两档，便于产品策略调整：

- `full`：启用所有目标协议与档位（本次需求期望的默认）。
- `safe`（可选）：仅启用最基础组合，用于诊断/降级（本次先不要求；后续如需要再补充）。

---

## 5. 驱动 API 与配置点（仅通过 `sw2303-rs`）

### 5.0 依赖版本基线（必须明确）

本仓库当前 `sw2303-rs` 依赖锁定在较旧的 Git revision（见 `Cargo.toml`）。团队反馈已在更新的 revision 中修复了部分问题，并在 `dfee82225d58200639bda54183126d808ddec55c` 提交中补齐/修复了关键能力。

因此本设计要求：实现阶段应优先升级到该 revision（或更新的稳定版本），并重新执行验证计划（§8）。

### 5.1 约束：固件不得直接寄存器访问

主人已确认：本项目中**除非明确调试目的，否则不允许**直接操作 `SW2303` 寄存器。

因此本仓库固件实现必须满足：

- 不得在固件代码中使用 `sw2303::registers::Register`，不得调用 `SW2303::read_register()` / `SW2303::write_register()`。
- 不得在固件代码中调用任何 “raw flags” 接口（例如 `*_raw` 方法）。
- 所有寄存器地址、位定义、bit 极性（0/1 语义）必须封装在 `sw2303-rs` 驱动内部；若驱动缺少能力，则先在驱动中补齐结构化 API，再由本项目调用。
- 若确需寄存器级调试：必须以 feature-gated 方式实现（默认关闭），且仅用于诊断/日志，不得参与业务逻辑或发布构建。

### 5.2 Profile 需要的驱动接口（MUST）

本项目的 `full` profile 需要 `sw2303-rs` 至少提供以下结构化能力（均为**驱动 API**，固件不感知寄存器）：

- 写入解锁：`SW2303::unlock_write_enable_0()`（或由 profile 一键应用 API 内部调用）
- 功率上限（100W）：`SW2303::set_power_config(100)` + `SW2303::get_power_config()`
- 协议启用集合：`SW2303::configure_protocols(ProtocolConfiguration)` + `SW2303::get_protocol_status()`
  - 目标：`pd/qc20/qc30/fcp/afc/scp/pe20/bc12/sfcp` 全部启用
- PD 档位集合：`SW2303::configure_pd(PdConfiguration)`
  - 目标：PD 启用、PPS 启用、`9/12/15/20V` 全启用、PPS0~PPS3 全启用
  - 100W 策略：默认不绕过 eMarker（`emark_5a_bypass=false`），避免在无 eMarker 情况下强行宣称 5A
- Type‑C 广播：`SW2303::configure_type_c(TypeCConfiguration)` + `SW2303::get_type_c_status()`
  - 默认建议：不强制广播 1.5A、不强制 “PD/PPS 5A” 广播（由 PD 协商决定）

### 5.3 需要在 `sw2303-rs` 补齐的接口（SHOULD）

为覆盖“全部档位”中与 QC/PE/非 PD 12V 等相关的能力开关，需要 `sw2303-rs` 提供“快充能力”结构化配置接口：

- `SW2303::configure_fast_charge(FastChargeConfiguration)` + `SW2303::get_fast_charge_status()`
  - 覆盖：SCP 广播电流、FCP/AFC/SFCP 高压限流、QC2.0/QC3.0/PE2.0 的 20V 支持、非 PD 12V 支持等

团队反馈：上述接口已在 `dfee82225d58200639bda54183126d808ddec55c` 引入/修复；若实现阶段仍锁定旧版本，则需先升级依赖后再实现 Profile。

同时建议增加一个“一键应用”入口，降低固件侧调用复杂度与出错面：

- `SW2303::apply_enable_profile_full(...) -> Sw2303ProfileApplyResult`
  - 内部流程：解锁 → 100W → protocol → PD → fast‑charge → type‑c → 读回校验 → 返回结果

> 重要流程约束：若 `sw2303-rs` 驱动存在问题（语义与手册不一致、缺少 API、写入不生效等），本项目应输出**具体问题清单与建议修复方向**，由负责 `sw2303-rs` 的同事分析并修复；本项目不擅自修改驱动实现。

### 5.4 读回校验与可观测性

- 读回校验应基于驱动的 `get_*` 方法（或新增 status API）完成；固件不直接读取寄存器。
- 日志输出建议：芯片版本号 + profile 名称 + 关键 status 字段 + 失败原因（用于定位“定制版/锁写/语义不一致”）。

### 5.5 现状差距（需要在实现阶段收敛）

- 当前本仓库固件存在直接寄存器读取：`src/pd_i2c/sw2303.rs` 通过 `read_register()` + `Register::*` 读取并解码 `PowerRequest`。
  - 该实现与“除调试外禁寄存器访问”的约束冲突；后续实现阶段需要改为：由 `sw2303-rs` 提供结构化的 `get_power_request()`（或等价 API），本仓库仅调用该 API。

---

## 6. 失败策略与安全边界

### 6.1 失败策略（已确认）

当 Profile 应用失败（写失败或读回不一致）时，采用 **策略 A（告警 + 降级继续运行）**：

- 继续运行现有只读/协同逻辑，但明确提示“协议/档位可能不全”，并输出关键 status 字段（通过驱动 `get_*` 读回）。
- 如需更深定位：仅在调试 feature 开启时附带寄存器快照（不得默认启用、不得进入发布构建）。
- 重试策略（冻结为基线）：
  - 启动阶段：最多重试 3 次，每次间隔 200ms（用于吸收上电/总线抖动）。
  - 运行阶段：仅在检测到 `SW2303` 复位/配置丢失或重新 init 时触发重试；两次重试之间至少 60s。

### 6.2 能力上限（必须明确）

“全协议/全档位”不应等价于“超出整机能力的广告/输出”。因此需要明确整机能力上限（至少包括）：

- 最大输出电压 `Vmax`
- 最大输出电流 `Imax`
- 最大输出功率 `Pmax`

本次已确认：`Pmax = 100W`。设计建议通过驱动 `set_power_config(100)` 显式设置为 100W，以减少“定制版默认值”带来的不确定性。

若后续确认 `SW2303` 的能力广告仍需要固件做额外钳位，则需扩展 Profile（当前先不引入更多假设）。

---

## 7. 兼容性与版本差异

- 寄存器手册的版本历史提示不同芯片版本可能存在默认值差异。建议在 `sw2303-rs` 中提供“读取芯片版本号”的结构化 API，并在日志中打印：
  - 芯片版本号
  - profile 应用结果
  - 关键 status 字段（通过驱动 `get_*` 获取）

---

## 8. 验证计划（实现后用于验收）

- **状态验证（通过驱动 API）**：
  - `get_power_config()` 返回 `register_mode=true` 且 `power_watts=100`
  - `get_protocol_status()` 返回各协议均为 enabled
  - `get_type_c_status()` 返回处于期望策略（默认不强制 1.5A/5A 广播）
  - 若补齐 `get_fast_charge_status()`：确认 QC/PE 20V、非 PD 12V、SCP 广播电流等处于期望值
- **行为验证**：用若干代表性设备验证协议触发与档位协商：
  - PD 固定档位（9/12/15/20）
  - PPS 档位（PPS0~PPS3 的目标区间内调节）
  - QC2/QC3、SCP（高/低压）、AFC/FCP/SFCP/PE、BC1.2（按“全覆盖”目标）
- **异常验证**：模拟写失败/读回不一致，确认失败策略按设计生效且可观测。

---

## 9. 已确认事项与剩余风险

### 9.1 已确认事项

- 协议范围：包含 `BC1.2 / PD / QC2.0 / QC3.0 / SCP(高压+低压) / AFC / FCP / SFCP / PE`。
- 档位范围：覆盖 PD 固定档位、PPS0~PPS3，以及非 PD 相关的 12V/20V 支持开关（由驱动提供结构化配置能力）。
- 能力上限：`Pmax = 100W`。
- 失败策略：策略 A（告警 + 降级继续运行）。

### 9.2 剩余风险（需在实现阶段验证）

- 由于 `sw2303-rs` 版本演进较快，历史上曾出现“位极性/位语义与手册不一致”的风险；实现阶段升级到目标 revision 后，仍需通过 §8 的“状态验证 + 行为验证”进行回归确认。
