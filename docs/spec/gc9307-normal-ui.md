# GC9307 正常界面规范（USB‑A + USB‑C/PD 双口电参量）

适用硬件：`tps-sw`（见 `docs/hardware-variants.md`）。  
本文为**规范（Spec）**：定义“正常界面”的对外可观察行为、显示格式与判定规则，作为后续实现与测试的基线。

相关文档（非规范）：

- `docs/gc9307-normal-ui-ui-design.md`：界面设计与像素效果图（含 1:1 渲染图）。
- `docs/gc9307-normal-ui-functional.md`：功能说明（面向使用者的解释）。

---

## 1. 背景与目标

当前 GC9307 屏幕显示为 TPS+SW 测试界面。将其替换为“正常界面”，用于日常观测屏幕下方两路接口：

- 左：USB‑A
- 右：USB‑C（支持 PD）

正常界面需要以两列形式分别显示两口的 **电压 / 电流 / 功率**，并提供一致、可读、定宽的显示格式与异常状态表示。

---

## 2. 范围与非目标

### 2.1 范围（In Scope）

- 两列三行显示：Voltage / Current / Power。
- 固定宽度数值格式化规则（含四舍五入、超量程、未插入、错误）。
- 数据源约束：V/I/P 来自对应口 INA226；**功率必须读 INA226 Power 寄存器**。
- 刷新策略：屏幕每 **500ms** 刷新一次。
- 端口“未插入”判定规则（见 §6）。

### 2.2 非目标（Out of Scope）

- 菜单/切页/交互、历史曲线、数据记录/上报。
- 显示 PD 协议细节（PDO、协议类型、请求值等）。
- 改动 PD 协同控制策略与主循环功能行为。

---

## 3. 端口与硬件映射（规范）

网表：`hardware/tps-sw/netlist.enet`

### 3.1 左列（USB‑A）

- 连接器：`USB4`（Type‑A）
- 电源网络：`P1_VBUS`
- INA226：`U13`
  - `A1=GND`、`A0=GND` → I2C 7-bit 地址 **`0x40`**
  - `Bus+`：`P1_VBUS`（pin8/pin9）
  - `Shunt`：`P1_SNP`（pin10）与 `P1_VBUS` 之间
- 分流电阻：`R22 = 10mΩ`（`P1_SNP ↔ P1_VBUS`）

### 3.2 右列（USB‑C / PD）

- 连接器：`USB5`（Type‑C）
- VBUS 网络：`VBUS_TPS`
- INA226：`U17`
  - `A1=GND`、`A0=3V3` → I2C 7-bit 地址 **`0x41`**
  - `Bus+`：`VOUT_TPS`（pin8/pin9）
  - `Shunt`：`ISP_TPS`（pin10）与 `VOUT_TPS` 之间
- 分流电阻：`R29 = 10mΩ`（`ISP_TPS ↔ VOUT_TPS`）
- 输出连接关系：`VOUT_TPS` 通过 `Q7` 连接到 `VBUS_TPS`

---

## 4. 显示布局（规范）

### 4.1 行/列定义

屏幕显示固定为 **3 行 × 2 列**：

- 行1：Voltage（单位 `V`）
- 行2：Current（单位 `A`）
- 行3：Power（单位 `W`）

两列分别对应：

- 左列：USB‑A
- 右列：USB‑C/PD

### 4.2 定宽字符布局

每行固定为 **13 个字符**：

`左单元(6) + 分隔(1 空格) + 右单元(6)`

每个“单元”固定为 **6 个字符**（见 §5）。

---

## 5. 显示格式（规范）

### 5.1 正常数值（必须定宽）

每个单元显示格式为：

- `dddd.dU`（四个数字 + 小数点 + 单位字母）
  - `U ∈ {V, A, W}`

小数点位置随量级变化（见 §5.4）。

### 5.2 未插入（端口不存在）

当端口判定为“未插入”时，该端口三行均显示：

- `--.--U`（6 字符；单位随行固定为 `V/A/W`）

### 5.3 错误与超量程

当端口判定为“已插入”，但对应测量/读取失败时：

- 显示 `ERROR `（6 字符，末尾 1 空格）

当端口判定为“已插入”，且数值超量程（`x ≥ 1000.0`）时：

- 显示 `OVER  `（6 字符，末尾 2 空格）

### 5.4 量级与舍入

对要显示的数值 `x`（单位分别为 V/A/W）：

- `0.000 ≤ x < 10.000` → `D.ddd`（3 位小数）
- `10.00 ≤ x < 100.00` → `DD.dd`（2 位小数）
- `100.0 ≤ x < 1000.0` → `DDD.d`（1 位小数）

舍入规则：按最终显示精度 **四舍五入（half-up）**。

允许跨阈值进位并切换格式：

- 例如 `9.9996V` → `10.00V`

### 5.5 颜色（规范）

本界面为彩色显示，颜色用于快速区分指标与异常状态（不改变字符布局）。

通用规则：

- 背景色：黑色（sRGB `#000000`；RGB565 `0x0000`）
- 正常数值（OK）颜色区间（主人要求）：Voltage 黄色系 / Current 红色系 / Power 绿色系
- 状态颜色（固定）：
  - 未插入（`--.--U`）：灰色（sRGB `#808080`；RGB565 `0x8410`）
  - 错误（`ERROR `）：红色（sRGB `#FF0000`；RGB565 `0xF800`）
  - 超量程（`OVER  `）：橙色（sRGB `#FF9800`；RGB565 `0xFCC0`）

正常数值（OK）配色（已选定；效果图见 `docs/gc9307-normal-ui-ui-design.md`）：

- Voltage：sRGB `#FFCA28`；RGB565 `0xFE45`
- Current：sRGB `#F44336`；RGB565 `0xF206`
- Power：sRGB `#4CAF50`；RGB565 `0x4D6A`

状态与颜色优先级：`未插入 > ERROR > OVER > OK`（见 §9）。

---

## 6. 端口“未插入”判定（规范）

### 6.1 USB‑A 未插入

以 USB‑A（U13）的 VBUS 电压判定：

- 若电压读数有效且 `< 1.0V` → 判定为“未插入”
- 否则判定为“已插入”

### 6.2 USB‑C(PD) 未插入

以 `SW2303` 的“协商/协议激活状态”判定：

- 若未处于协议激活状态 → 判定为“未插入”
- 否则判定为“已插入”

约束：

- 不得使用 `SW2303` 的 `online` bit 作为功能判定依据。
- 不得使用 “VBUS 是否为 5V keep-alive” 来判定未插入。

---

## 7. 数据来源与换算（规范）

### 7.1 电压与电流

- 电压：读取 INA226 Bus Voltage 寄存器并按 datasheet 换算为 V。
- 电流：读取 INA226 Current 寄存器并按校准参数换算为 A。

若读取失败或电流为负值（raw < 0）：

- 视为该项 `ERROR`。

### 7.2 功率（必须来自 INA226）

功率：读取 INA226 Power 寄存器。

换算必须与 INA226 定义一致：

- `Power_LSB = 25 × Current_LSB`

若读取失败：

- 视为该项 `ERROR`。

---

## 8. 刷新（规范）

- 屏幕刷新周期：**500ms**。
- 每次刷新应使用当前可用的最新测量值；测量采样频率不在本规范中强制规定。

---

## 9. 状态优先级（规范）

对每个端口、每个指标项（V/A/W），渲染状态优先级如下：

1) 端口未插入 → `--.--U`  
2) 端口已插入且读取失败/非法值 → `ERROR `  
3) 端口已插入且超量程（`x ≥ 1000.0`） → `OVER  `  
4) 否则按 §5.4 输出正常数值

---

## 10. 验收标准（Acceptance Criteria）

### 10.1 核心显示

- Given：进入正常界面  
  When：每 500ms 触发一次刷新  
  Then：显示 3 行 × 2 列的 V/A/W 内容，且每行严格满足 13 字符布局（左 6 + 空格 + 右 6）。

### 10.2 未插入/错误/超量程

- USB‑A：当电压 `<1.0V` 时，该口三行均显示 `--.--U`。
- USB‑C：当协议未激活时，该口三行均显示 `--.--U`。
- 插入状态下任一项读取失败显示 `ERROR `，不影响其它项显示。
- 插入状态下任一项 `x ≥ 1000.0` 显示 `OVER  `。

### 10.3 格式化

- 任意正常数值必须满足“4 个数字 + 小数点 + 单位字母”的定宽要求。
- 在阈值附近的四舍五入与跨阈值进位符合 §5.4。
