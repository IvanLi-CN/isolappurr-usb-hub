# Hardware Button Action Tones（按键动作结果提示音）设计

## 背景

当前设备有左右两个物理按键，但缺少“动作已完成/成功失败”的明确反馈。为了让用户在无需盯屏的情况下也能确认操作结果，需要在动作执行完成后播放短且干净的提示音，并区分成功与失败。

本设计仅覆盖“按键 → 占位动作 → 成功/失败提示音”的闭环；实际业务动作后续再接入。

## 目标

- **结果反馈**：仅在动作完成后播放提示音（不是按下瞬间）。
- **可辨识**：成功/失败提示音显著不同、且足够短促干净。
- **非阻塞**：不引入 busy-wait 播放；复用现有蜂鸣器 `prompt_tone` 状态机。
- **反馈优先**：当安全报警（`SafetyAlarm`）持续播放时，动作结果提示音仍必须可被听到（通过临时暂停/抑制 `SafetyAlarm` 实现；结束后如安全态仍 active 则立即恢复；不排队、不补播）。

## 范围

- 物理按键输入：左右键（`BTNL/BTNR`）轮询采样 + 去抖 + “按下事件”检测。
- 占位动作：
  - 左键动作：固定返回成功（`Ok`）。
  - 右键动作：固定返回失败（`Err`）。
- 提示音：
  - 成功：单短击。
  - 失败：双短击（两声短 tone + 中间短静默）。
- 与 `prompt_tone` 集成：新增对应的事件/音效 ID 与 pattern，并定义“安全报警期间抑制”的策略。

## 非目标

- 不实现真实业务功能（仅占位）。
- 不实现“按下瞬间”的按键点击音（只做结果音）。
- 不新增音量/静音配置项。
- 不改变现有 Boot/Warning/Error 的既定提示音模式；`SafetyAlarm` 仅增加“可被动作结果音短暂打断后恢复”的交互规则（见下文）。

## 硬件与约束（从网表/现有固件提取）

- 蜂鸣器：`BUZZER=GPIO21`，通过 NPN 低边开关驱动；固件侧需保持低占空比的保守策略。
- 右键：`BTNR=GPIO0`，按下接地（低电平有效）。
- 左键：`BTNL=GPIO1`，按下接地（低电平有效）。
- 网表未见外部上拉：固件需启用内部上拉（Pull-Up）。
- **风险（硬件固有）**：`GPIO0` 为启动配置相关管脚；若用户在上电/复位时按住右键，可能影响启动模式（下载模式等）。本设计不改变硬件事实，仅在风险章节提示。

## 关键用例 / 用户流程

1) **左键成功**
- 用户按下左键 → 去抖后识别“按下事件” → 执行 `ActionLeft()` → 返回 `Ok` → 播放成功提示音（单短击）。

2) **右键失败**
- 用户按下右键 → 去抖后识别“按下事件” → 执行 `ActionRight()` → 返回 `Err` → 播放失败提示音（双短击）。

3) **安全报警期间抑制**
- 系统进入安全报警（`SafetyAlarm` 循环） → 用户按左右键 → 动作仍可执行（是否执行取决于后续业务接入），并且动作结果提示音必须仍可被听到：播放动作结果音前临时暂停/抑制 `SafetyAlarm`，播放后若安全态仍 active 则恢复。

## 设计概述

### 1) 按键输入：轮询 + 去抖 + 边沿检测

现有主循环约每 10–50ms 迭代一次（由 loop_delay 控制）。在此节奏下采用轮询去抖即可满足响应需求。

建议行为（形状说明，非实现代码）：

- 采样：每轮读取 `BTNL/BTNR` 电平（低=按下）。
- 去抖：当检测到电平变化时，要求新电平保持稳定达到 `DEBOUNCE_MS`（建议 20–40ms）才确认状态切换。
- 事件：仅在稳定态从“未按下”切换为“按下”时产生一次 `Pressed` 事件（按住不连发）。

### 2) 占位动作：左右键固定成功/失败

占位动作用于先验证“按键→结果音”链路，不引入真实业务副作用：

- `ActionLeft()`：立即返回 `Ok`。
- `ActionRight()`：立即返回 `Err`。

后续接入真实功能时，要求保持“先执行动作、后根据 Result 发声”的时序不变。

### 3) 提示音：复用 `prompt_tone`，新增动作结果音效

建议在 `prompt_tone` 的声音目录中新增两个 one-shot 音效（命名可实现阶段微调，但需要稳定区分）：

- `ActionOkOnce`：成功单短击
- `ActionFailOnce`：失败双短击

推荐参数（遵循低占空比保守策略）：

- Success（单短击）：`freq=2200Hz, duty=6%, 60–80ms`
- Fail（双短击）：`freq=2200Hz, duty=6%, 60ms + 60ms silence + 60ms`

### 4) 安全报警期间 Duck/让位策略

当 `SafetyAlarm` 处于 active/playing 状态时：

- 动作结果提示音必须仍可播放：在播放 `ActionOkOnce/ActionFailOnce` 前临时**暂停/抑制** `SafetyAlarm`，播放结束后若安全态仍 active 则**立即恢复** `SafetyAlarm`。
- 不对“被打断的报警片段”做补播，也不对动作结果音做排队延后（避免误导与积压）。

落点建议：

- 在 `PromptToneManager.notify(...)`（或等价入口）中对“动作结果事件”做显式分支：若 `safety_active==true`，则先暂停/抑制 `SafetyAlarm`，立即播放动作结果音，并在动作结果音结束后恢复 `SafetyAlarm`（若仍处于安全态）。
- 由提示音层统一实施 Duck/恢复，业务调用方只负责上报 `ActionOk/ActionFail`，无需理解内部细节。

## 接口与模块边界（概要）

- `button`（新增小模块，或直接在 `main` 内局部实现）：
  - 输入：GPIO0/GPIO1
  - 输出：`ButtonEvent::Pressed(Left|Right)`
- `actions`（占位动作模块/函数）：
  - 输入：`ButtonId`
  - 输出：`Result<(), ActionError>`
- `prompt_tone`（既有模块，扩展）：
  - 输入：`SoundEvent::ActionOk` / `SoundEvent::ActionFail`（或等价表达）
  - 输出：蜂鸣器播放对应 pattern；在 `SafetyAlarm` active 时抑制动作结果事件

## 兼容性与迁移

- 仅新增按键输入与两种新提示音，不改变现有 PD loop 的功能行为。
- 不涉及 Web UI、存储迁移或配置变更。
- 保持 `no_std`，无堆分配。

## 验收标准（实现基线）

- 左键一次有效按下 → 占位动作返回 `Ok` 后播放成功单短击；按住不连发、抖动不重复触发。
- 右键一次有效按下 → 占位动作返回 `Err` 后播放失败双短击；两者可明显区分且整体时长短（建议 ≤250ms）。
- `SafetyAlarm` active 时按键触发的动作结果提示音仍可被清晰听到：播放动作结果音前暂停/抑制 `SafetyAlarm`，播放结束后若安全态仍 active 则恢复；不排队、不补播。

## 风险与待确认

- `GPIO0` 启动配置风险：上电/复位时按住右键可能影响启动模式。若这会干扰实际使用，需要后续在产品说明或交互上规避（不在本设计范围内）。
- 去抖窗口取值：默认建议 20–40ms；若实机按键抖动更严重需调整。
