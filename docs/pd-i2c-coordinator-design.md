# USB-PD I2C 协同（SW2303 → TPS55288）需求分析与概要设计

本文档用于 **设计阶段**：规划如何在本项目中使用 **同一条 I2C 总线**，由 MCU **轮询 SW2303** 获取协商后的目标参数，并将其 **转换/量化后写入 TPS55288**，从而实现 USB‑PD 输出电压/电流的协同控制。

> 重要范围约束：本次工作 **只允许** MCU 与 `SW2303`、`TPS55288` 两个 I2C 从设备通信；不得与其他 I2C 设备通信，也不得做 I2C 地址扫描。

---

## 1. 背景与目标

### 1.1 背景

- `SW2303` 会根据 Type‑C/PD 协议协商结果，形成内部的“目标电压/限流”参数；其寄存器中可读取到当前设置值。
- `TPS55288` 是可编程 buck‑boost 电源，通过 I2C 可设置输出电压 DAC、输出限流、斜率等参数。

### 1.2 目标

- MCU 通过 **轮询** 从 `SW2303` 获取：
  - 在线状态（sink device online/offline）
  - 协议类型（PD FIX / PD PPS 等）
  - 当前目标电压（`dac_vol`）
  - 当前目标限流（`ctrl_icc`）
- MCU 将上述信息转换为 `TPS55288` 可接受的 setpoint，并仅在变化时写入，保持输出与协商一致。
- 固件层面 **严格限制**：I2C 只允许访问 `SW2303 (0x3C)` 与 `TPS55288 (0x74)`，禁止扫描与“误触碰其他地址”。（依据：网表 `R35=0Ω` 将 TPS55288 `MODE` 下拉到 `AGND_TPS`，对应 I2C 地址为 `74h`）

---

## 2. 范围与非目标

### 2.1 范围（In Scope）

- `SCL_TPS/SDA_TPS` 总线初始化（400 kHz）与 I2C 事务白名单约束。
- `SW2303` 的轮询读取与寄存器解码（只读路径）。
- `TPS55288` 的 setpoint 下发策略（电压/电流/使能/斜率，按需最小写入）。
- 协调状态机（online/offline、故障、I2C 异常恢复的基本策略）。
- 设计验证计划（逻分、日志、基本行为验证）。

### 2.2 非目标（Out of Scope）

- 在 PD 总线（`SCL_TPS/SDA_TPS`）上与 `INA226` 或其他器件通信（明确禁止；遥测应使用独立的 `I2C1`）。
- 任何 I2C 地址扫描、总线探测工具、或对“未知地址”的容错访问。
- Web UI、配置持久化、远程控制等非电源协同核心功能。
- `SW2303` 的协议策略重配置（除非后续明确新增需求）。

---

## 3. 硬件与网表确认（总线/引脚/上拉）

本项目 PD 协同 I2C 总线网名为：

- `SCL_TPS`
- `SDA_TPS`

来自网表 `docs/netlist/pcb.enet` 的关键连接：

- MCU（U19，ESP32‑S3R2）：
  - pin44（GPIO39 / `MTCK`）→ `SDA_TPS`
  - pin45（GPIO40 / `MTDO`）→ `SCL_TPS`
  - pin42（GPIO37）→ `CE_TPS`
  - pin43（GPIO38）→ `INT_TPS`
- TPS55288（U14）：
  - pin5 → `SCL_TPS`
  - pin6 → `SDA_TPS`
- SW2303（U16）：
  - pin1  → `SDA_TPS`
  - pin16 → `SCL_TPS`
- 上拉：`RN2` 为 `SCL_TPS/SDA_TPS`（以及 `INT_TPS`）提供到 `3V3` 的 4.7 kΩ 上拉。

### 3.1 引脚复用风险（ESP32‑S3）

根据 ESP32‑S3 数据手册 IO MUX 表（本仓库 `downloads/.../full.md`），物理 pin44/pin45（GPIO39/GPIO40）默认复用为 `MTCK/MTDO`。使用这两脚做 I2C 需要在系统设计中明确：

- 是否放弃“传统 JTAG”调试引脚占用；
- 或改用 USB Serial/JTAG、或其它调试方式。

---

## 4. I2C 协议与地址约束

### 4.1 总线速率

- `SW2303` 支持 100k/400k，因此本总线配置为 **400 kHz**。

### 4.2 地址白名单（强约束）

- `SW2303`：`0x3C`
  - `TPS55288`：`0x74`  
  依据：网表显示 `TPS55288 MODE`（pin15）通过 `R35=0Ω` 接到 `AGND_TPS`，按数据手册 MODE 电阻配置表，对应 I2C 地址为 `74h`。

固件必须实现 **allowlist wrapper**：任何对非白名单地址的 `write/write_read` 直接拒绝并记录错误（用于保证“不得与其他设备通信”的范围要求）。

---

## 5. 关键用例 / 流程

### 5.1 上电到可输出

1) MCU 初始化 `SCL_TPS/SDA_TPS` I2C（400 kHz）与地址白名单。  
2) 轮询 `SW2303` online 状态：由 offline → online 稳定 N 次（例如 3 次）后进入跟随。  
3) 读取 `SW2303` 当前设置（目标电压/限流/协议），转换成 TPS setpoint。  
4) 写入 `TPS55288`（先限流、后电压、最后使能）。  

### 5.2 协商变化 / PPS 调节

- MCU 按固定周期轮询 `SW2303`。
- 当检测到目标电压/限流变化时，仅写入发生变化的 TPS 寄存器（避免无意义 I2C 流量）。

### 5.3 设备断开（offline）

- 发现 `SW2303` offline：立即关闭 `TPS55288` 输出（软关断/硬关断策略见 §7）。
- 返回等待 online 状态。

### 5.4 TPS 故障（SCP/OCP/OVP）

- MCU 读取 `TPS55288 STATUS`，若出现故障位：
  - 立刻关断输出
  - 进入 `Fault` 状态，执行退避与重试策略（或等待人工介入，取决于产品策略）

---

## 6. 数据/领域模型（固件内部）

建议在固件内部明确 2 层模型，避免“原始寄存器值”与“最终写入值”混淆：

- `PowerRequest`（来自 SW2303，含在线/协议/目标值）
- `PowerSetpoint`（将写入 TPS55288 的量化结果）

字段形状示例（仅示意）：

- `PowerRequest { online: bool, protocol: u8, v_req_mv: u16, i_req_ma: u16 }`
- `PowerSetpoint { v_out_mv: u16, i_lim_ma: u16, output_enabled: bool }`

---

## 7. SW2303 轮询读取与解码（只读）

> 说明：`sw2303-rs` 当前存在高层 `get_voltage()/set_voltage()` 的寄存器解码偏差风险；本方案建议使用 `read_register()` 读取寄存器原始值并在协同层正确解码（仍然“使用该驱动”，但不依赖其不匹配的便捷 API）。

基于 `SW2303` 寄存器手册（`sw2303-rs` 仓库：`docs/SW2303_寄存器手册__Release_RG013_1_v1.4.md`）：

- 在线状态：
  - `REG0x0D` bit7：`DEVICE_ONLINE`
- 协议类型：
  - `REG0x06` bits[3:0]
- 目标电压（当前设置电压）：
  - `REG0x03`：`dac_vol[11:4]`
  - `REG0x04`：`dac_vol[3:0]` 位于 bits[7:4]
  - `Vreq_mv = dac_vol * 10mV`
- 目标限流（当前设置的限流）：
  - `REG0x05`：`ctrl_icc[6:0]`
  - `Ireq_ma = 1000mA + ctrl_icc * 50mA`

轮询周期建议：

- 变更/协商阶段：5 ms
- 稳态阶段：10 ms（或更长）

---

## 8. TPS55288 setpoint 写入策略

### 8.1 量化与钳位

TPS55288 驱动（`tps55288-rs` 仓库）的抽象假定：

- 电压：`0.8V` 起，`20mV/LSB`（10-bit DAC）
- 电流：`50mA/LSB`，最大约 `6.35A`

因此建议的转换策略：

- 电压：
  1) `Vreq_mv` 先钳位到产品允许范围（例如 3300–21000mV；最终范围以硬件/需求为准）
  2) 按 TPS 分辨率 `20mV` 量化，建议 **向下取整**（避免超出 SW2303 当前设定）
- 电流：
  1) `Ireq_ma` 钳位到 `<= 6350mA`
  2) 可选做 50mA 安全余量：`Itps_ma = max(0, Ireq_ma - 50)`

### 8.2 写入顺序（推荐）

为了避免短暂的“电压已升高但限流未到位”，推荐顺序：

1) 软禁能（确保 OE=0）
2) 写限流 `IOUT_LIMIT`
3) 写电压 DAC（`REF0/REF1`）
4) 再使能输出（OE=1）

此外，建议启用/设置：

- `VOUT_SR`（输出电压变化斜率）：根据产品体验选择（例如 2.5mV/µs）
- `MODE` / `VOUT_FS`：保持与电压抽象一致（注意与硬件连接关系，见 §10 风险点）

### 8.3 最小写入原则

- 维护 `last_setpoint`，仅在以下条件发生变化时写 TPS：
  - `v_out_mv` 变化（量化后）
  - `i_lim_ma` 变化（量化后）
  - `online`/`protocol` 变化导致启停策略变化

---

## 9. 使能与安全态（软关断 + 硬关断）

### 9.1 硬关断：`CE_TPS`

网表显示 MCU 有 `CE_TPS` 控制链路（经 `Q9` 下拉 TPS `EN/UVLO` 节点），可作为硬关断兜底：

- `SW2303 offline`、或
- `TPS STATUS` 报 `SCP/OCP/OVP`、或
- I2C 连续失败达到阈值

→ 立即拉起 `CE_TPS`（使 `Q9` 导通，将 `EN/UVLO` 节点下拉到 GND，进入硬关断）。

### 9.2 软关断：TPS `OE`

正常流程中，优先通过 I2C 清 `OE` 实现平滑停机；遇到异常再使用 `CE_TPS` 兜底。

---

## 10. 风险点与待确认问题（必须在实现前定稿）

### 10.1 SW2303 反馈相关的硬件一致性说明（已确认）

> 结论先写明：根据本次原始需求，本次交付的**唯一架构**是：MCU **轮询 `SW2303`** 获取协商目标（电压/限流/状态）→ 转换/量化 → **写入 `TPS55288`** 实现输出跟随。

`SW2303` 数据手册描述了 `VFB/OPTO/FB` 相关的反馈工作方式；若 `OPTO/FB` 与外部电源反馈网络相连，可能与“MCU 通过 I2C 设定 TPS 输出”的控制路径产生冲突。

**当前结论（已确认）：** 主人确认 `SW2303 OPTO/FB` 与 `FB_TPS` 之间的短接电阻未焊接，因此在当前版本中两者**无电气连接**，不存在“反馈节点争用”的一致性风险。本设计按本文档方案推进即可。

若未来硬件版本更改导致两者建立连接，需要重新评审本设计文档。

### 10.2 ESP32‑S3 调试接口占用

`SDA_TPS/SCL_TPS` 使用物理 pin44/pin45（复用 `MTCK/MTDO`），需确认调试方案（USB‑Serial‑JTAG vs 传统 JTAG）。

### 10.3 SW2303 数据手册中的 I2C “Register address = 0xB0” 表述歧义

SW2303 数据手册的 I2C 章节存在 “Register address = 0xB0” 的表述；本方案以寄存器手册与 `sw2303-rs` 的寄存器映射为准，避免误解实现。

---

## 11. 验证计划（实现后用于验收）

- I2C 约束验证：
  - 日志/断言证明只发生对 `0x3C` 与 `TPS55288` 实际地址的访问
  - 禁止地址扫描
- 功能验证：
  - offline→online：在一个轮询窗口内完成 TPS 配置并使能
  - PPS 调节：输出随 `Vreq` 变化平滑跟随（按 `VOUT_SR`）
- 可靠性验证：
  - I2C 超时/卡死：能够恢复（重新 init 或 SCL 翻转恢复）
  - TPS 报 `SCP/OCP/OVP`：能快速关断并进入安全态
