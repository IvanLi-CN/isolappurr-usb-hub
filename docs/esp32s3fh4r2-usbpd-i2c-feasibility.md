# ESP32‑S3FH4R2 方案（选型阶段）驱动 SW2303 + TPS55288 + 2×INA226 的可行性分析

本报告用于**选型阶段**：在既有 `docs/esp32c3-usbpd-i2c-feasibility.md` 的基础上，针对“**引脚不够用**”的现状，评估选择 **ESP32‑S3FH4R2** 作为主控方案时：

- I2C 外设数量（是否可分两条总线）；
- 总线速率与器件速率匹配；
- 轮询 SW2303 的端到端响应是否满足 USB‑PD 的电源切换时间窗；
- 可靠性风险与工程建议。

> 范围说明：本文重点仍是“USB‑PD 相关电源协同 + I2C 性能/鲁棒性”。关于 S3 与 C3 在 GPIO 数量/封装差异/外设差异等非本文重点内容，请以你的具体封装与原理图为准。

---

## 0. 结论摘要（先给结论）

- **ESP32‑S3 有 2 条 I2C 控制器（I2C0 / I2C1）**：可选把“PD 协同总线”和“遥测采样总线”拆开，进一步降低耦合与单点故障风险。
- **速度仍以 SW2303 为上限**：SW2303 仅支持 100k/400k，因此无论单总线或双总线，建议把与 SW2303 同总线的 I2C 频率设为 **400 kHz**。
- **可行且更稳**：哪怕全部器件共用一条 400 kHz I2C，总线吞吐也足够；使用双 I2C 分线后，轮询抖动与“测量流量干扰 PD 协同”的风险更低。

---

## 1. 关键差异：ESP32‑S3 vs ESP32‑C3（与本问题相关）

### 1.1 I2C 外设数量

ESP‑IDF 文档说明 **ESP32‑S3 有 2 个 I2C 控制器**（I2C controller(s) = 2）。  
参考：Espressif ESP‑IDF I2C（ESP32‑S3）文档。

### 1.2 I2C 频率建议

ESP‑IDF 对 I2C 主机模式同样给出建议：**SCL 不应超过 400 kHz**（Fast‑mode）。  
参考：Espressif ESP‑IDF I2C（ESP32‑S3）文档。

> 备注：因此“多一条 I2C”带来的主要收益是 **隔离/并行** 与 **鲁棒性**，而不是把同一条总线加速到 >400 kHz。

---

## 2. 外设与从设备能力（与 C3 版本一致的约束）

### 2.1 SW2303（轮询源）

- SW2303 I2C 支持 **100k/400k**；主机通过 I2C 读取状态信息。  
  `downloads/4c043a67-9736-4f94-9ded-5f4966d5e1da/d43f2be6-9968-4282-9fa1-788383da2c7f/full.md:178`

结论：**与 SW2303 同总线的 I2C 频率上限为 400 kHz**。

### 2.2 TPS55288（被控电源）

- TPS55288 I2C 支持 Standard‑mode（≤100 kbit/s）和 Fast‑mode Plus（≤1000 kbit/s）。  
  `downloads/50b5ca01-d68a-4c36-9238-b890259d8dd3/dd540207-b427-4999-b2ab-22f20c518a95/full.md:476`
- 输出电压变化斜率可由 `VOUT_SR` 设置（1.25/2.5/5/10 mV/µs）。  
  `.../full.md:594`

### 2.3 INA226（低频采样）

- INA226 支持 I2C Fast‑mode 至 **400 kHz**。  
  `downloads/71697b21-f2aa-4e69-b755-414ce23ffa1b/6a87f1e2-f25a-4b38-9e21-a56eb6a1db90/full.md:409`

---

## 3. 总线拓扑建议（S3 的新增选项）

ESP32‑S3 的 2 条 I2C 控制器给出两种合理拓扑：

### 3.1 方案 A：单总线（最省引脚）

- I2C0：SW2303 + TPS55288 + 2×INA226 共用
- 频率：400 kHz

结论：从 `docs/esp32c3-usbpd-i2c-feasibility.md` 的估算可知，**带宽足够**；但测量读数、偶发 I2C 异常会与 PD 协同共享同一条总线。

### 3.2 方案 B：双总线（更稳，仍较省资源）

- I2C0（“PD 协同总线”）：SW2303 + TPS55288（400 kHz）
- I2C1（“遥测总线”）：2×INA226（400 kHz 或更低均可）

优势：

- INA226 的低频访问不会影响 SW2303 轮询与 TPS 编程时序；
- 任一总线发生 SDA 卡低/噪声引发的问题，影响面被限制在各自总线上（更易恢复、更易定位）。

代价：

- 需要额外 2 个 GPIO（SCL1/SDA1）与对应上拉电阻。

---

## 4. 性能与响应（结论保持不变）

### 4.1 I2C 吞吐

INA226 1–2 Hz 的采样对吞吐几乎无影响（见 C3 版本文档第 3 节估算）。  
双总线时更是“完全隔离”，总线吞吐不是瓶颈。

### 4.2 端到端响应

端到端响应由三段构成：

1) 轮询等待（T_poll）  
2) I2C 写 TPS55288（亚毫秒）  
3) TPS55288 按 `VOUT_SR` 斜率完成输出变化（毫秒量级）

在 **5–10 ms** 的轮询周期与默认 2.5 mV/µs 斜率下，典型 “5V→20V” 输出变化约 **6 ms**（详见 TPS55288 文档）。  
因此总响应通常为 **几十毫秒以内**，仍远小于 USB‑PD 对 PS transition 的超时上限（数百毫秒量级，参考 Zephyr 的 USB‑PD timer 常量实现）。

---

## 5. 可靠性风险与工程建议（S3 仍适用）

- **轮询任务高优先级**：把 SW2303 轮询 + TPS 更新置于高优先级任务，避免日志/网络/USB 等任务造成长阻塞。
- **I2C 超时与总线恢复**：每次事务必须有 timeout；失败时执行 SCL 翻转恢复 + 重新初始化外设；watchdog 兜底卡死路径。
- **地址/电平/上拉/布线**：同 C3 文档第 5.3 节；双总线时两条总线都要按 400 kHz 的上升沿要求布线与选值，并远离电源开关节点。

---

## 6. 推荐参数（给你一个默认可用的“稳妥档”）

- 拓扑：优先 **方案 B（双总线）**；若 GPIO 仍紧张则退回方案 A
- I2C0（SW2303/TPS55288）：400 kHz
- I2C1（INA226）：100–400 kHz（建议同样 400 kHz，统一驱动与时序）
- SW2303 轮询周期：5–10 ms（协商/变更阶段用 5 ms，稳态可放宽）

---

## 参考链接（便于复核）

- Espressif ESP‑IDF I2C（ESP32‑S3）：https://docs.espressif.com/projects/esp-idf/en/latest/esp32s3/api-reference/peripherals/i2c.html
- SW2303 I2C 速率：`downloads/4c043a67-9736-4f94-9ded-5f4966d5e1da/d43f2be6-9968-4282-9fa1-788383da2c7f/full.md:178`
- TPS55288 I2C 速率与 `VOUT_SR`：`downloads/50b5ca01-d68a-4c36-9238-b890259d8dd3/dd540207-b427-4999-b2ab-22f20c518a95/full.md:476`、`.../full.md:594`
- INA226 I2C 速率：`downloads/71697b21-f2aa-4e69-b755-414ce23ffa1b/6a87f1e2-f25a-4b38-9e21-a56eb6a1db90/full.md:409`
