name: desktop

on:
  pull_request:
  push:
  workflow_dispatch:

jobs:
  macos:
    runs-on: macos-14
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Web install
        run: bun install --frozen-lockfile
        working-directory: web

      - name: Web check
        run: bun run check
        working-directory: web

      - name: Setup Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Install tauri-cli
        run: cargo install tauri-cli --version 2.9.6 --locked
        working-directory: desktop

      - name: Desktop build (bundle app, unsigned)
        run: cargo tauri build --ci --bundles app --no-sign
        working-directory: desktop

      - name: Ad-hoc sign and verify
        run: |
          APP="src-tauri/target/aarch64-apple-darwin/release/bundle/macos/isolapurr-desktop.app"
          codesign -s - --force --deep --timestamp=none "$APP"
          codesign --verify --deep --strict --verbose=2 "$APP"
        working-directory: desktop

